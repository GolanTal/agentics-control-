name: agentics-scheduler

on:
  schedule:
    - cron: "0 13 * * 1"     # Mon plan
    - cron: "0 14 * * 1-5"   # Weekdays content
    - cron: "0 21 * * 5"     # Fri report
  workflow_dispatch:

jobs:
  daily_content:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt

      # ðŸ”Ž Sanity check (doesn't print secrets, just presence/length)
      - name: Sanity check env
        run: |
          python - <<'PY'
          import os
          print("APPS_URL set? ", bool(os.environ.get("APPS_URL")))
          print("APPS_TOKEN length: ", len(os.environ.get("APPS_TOKEN","")))
          print("CONTROL_SHEET_ID set? ", bool(os.environ.get("CONTROL_SHEET_ID")))
          print("GOOGLE_SERVICE_ACCOUNT_JSON set? ", bool(os.environ.get("GOOGLE_SERVICE_ACCOUNT_JSON")))
          PY
        env:
          APPS_URL:  ${{ secrets.APPS_URL }}
          APPS_TOKEN: ${{ secrets.APPS_TOKEN }}
          CONTROL_SHEET_ID: ${{ secrets.CONTROL_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

      - name: Run pipeline
        run: bash scripts/run_pipeline.sh
        env:
          APPS_URL:  ${{ secrets.APPS_URL }}
          APPS_TOKEN: ${{ secrets.APPS_TOKEN }}
          CONTROL_SHEET_ID: ${{ secrets.CONTROL_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

  weekly_report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt

      # ðŸ”Ž Optional sanity check here, too
      - name: Sanity check env
        run: |
          python - <<'PY'
          import os
          print("CONTROL_SHEET_ID set? ", bool(os.environ.get("CONTROL_SHEET_ID")))
          print("GOOGLE_SERVICE_ACCOUNT_JSON set? ", bool(os.environ.get("GOOGLE_SERVICE_ACCOUNT_JSON")))
          PY
        env:
          CONTROL_SHEET_ID: ${{ secrets.CONTROL_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

      - name: Build analytics one-pager
        run: python agents/analyst.py
        env:
          CONTROL_SHEET_ID: ${{ secrets.CONTROL_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
